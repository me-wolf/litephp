<?php
namespace LITE;

/**
 * database query string class
 * Class DB_Query
 */
class DB_Query {
	private $sql = '';
	private $table_prefix = '';
	private $operation = 'SELECT';
	private $fields = array('*');
	private $tables = array();
	private $where = '';
	private $order = '';
	private $group = '';
	private $limit;
	private $data;

	//文件cache，默认为0（不进行cache）
	public $cache_expired = 0;

	public function __construct($sql=''){
		$this->sql = $sql;
	}

	/**
	 * set query string
	 * @param $sql
	 * @return $this
	 */
	public function setSql($sql){
		$this->sql = $sql;
		return $this;
	}

	/**
	 * 设置表前缀
	 * @param string $table_prefix
	 * @return $this
	 */
	public function setTablePrefix($table_prefix=''){
		$this->table_prefix = $table_prefix;
		return $this;
	}

	/**
	 * 查询
	 * @param string $str
	 * @return $this
	**/
	public function select($str='*'){
		$this->operation = 'SELECT';
		$this->field($str);
		return $this;
	}

	/**
	 * 更新
	 * @return $this
	**/
	public function update(){
		$this->operation = 'UPDATE';
		return $this;
	}

	/**
	 * 设置查询时间，仅对all、page、one有效
	 * @param $cache_expired
	 * @return $this
	 */
	public function cache($cache_expired=60){
		$this->cache_expired = $cache_expired;
		return $this;
	}

	/**
	 * 插入
	 * @return $this
	 */
	public function insert(){
		$this->operation = 'INSERT';
		return $this;
	}

	/**
	 * 删除
	 * @return $this
	 */
	public function delete(){
		$this->operation = 'DELETE';
		return $this;
	}

	/**
	 * 设置数据（仅对update, replace, insert有效)
	 * @param array $data
	 * @return $this
	 */
	public function setData(array $data){
		$this->data = $data;
		return $this;
	}

	/**
	 * 字段
	 * @param string $str
	 * @return $this
	**/
	public function field($str='*'){
		if($str == '*'){
			return $this;
		}
		$this->fields = explode(',', $str);
		$this->fields = $this->escapeKey($this->fields);
		return $this;
	}

	/**
	 * 表
	 * @param string $str
	 * @return $this
	**/
	public function from($str){
		$tables = explode(',', $str);
		foreach($tables as $key=>$table){
			$tables[$key] = $this->escapeKey($this->table_prefix.$table);
		}
		$this->tables = $tables;
		return $this;
	}

	/**
	 * 条件
	 * @param string $str
	 * @return $this
	**/
	public function where($str=''){
		if($str){
			$this->where = $str;
		}
		return $this;
	}

	/**
	 * 排序
	 * @param string $str
	 * @return $this
	**/
	public function order($str){
		$this->order = explode(',', $str);
		return $this;
	}

	/**
	 * 分组
	 * @param string $str
	 * @return $this
	**/
	public function group($str){
		$this->group = $str;
		return $this;
	}

	/**
	 * 设置查询限制，如果提供的参数为0，则表示不进行限制
	 * @throws Exception
	 * @return $this
	 */
	public function limit(/**$p1,$p2**/){
		list($p1, $p2) = func_get_args();
		if($p2){
			$this->limit = array($p1,$p2);
		} else if(is_array($p1)){
			$this->limit = $p1;
		} else if (is_scalar($p1) && $p1 != 0) {
			$this->limit = array(0, $p1);
		}

		if($this->sql && $this->limit){
			if(preg_match('/\slimit\s/', $this->sql)){
				throw new Exception('SQL LIMIT SET:' . $this->sql);
			}
			$this->sql = $this->sql . ' LIMIT ' . $this->limit[0] . ',' . $this->limit[1];
		}
		return $this;
	}

	/**
	 * @param string $sql
	 * @return int
	 */
	public static function isWriteOperation($sql=''){
		return !preg_match('/^select\s/i', $sql);
	}

	/**
	 * escape field key
	 * auto ignore by space or custom query string
	 * @param $field
	 * @return string
	 */
	private function escapeKey($field){
		if(is_array($field)){
			$ret = array();
			foreach($field as $val){
				$ret[] = strpos($val, '`') === false && strpos($val, ' ') === false ? "`$val`" : $val;
			}
			return $ret;
		} else {
			return strpos($field, '`') === false && strpos($field, ' ') === false ? "`$field`" : $field;
		}
	}

	/**
	 * output sql query string
	 * @return string
	 * @throws Exception
	 */
	public function __toString(){
		if($this->sql){
			return $this->sql;
		}

		switch($this->operation){
			case 'SELECT':
				$sql = 'SELECT '.implode(',', $this->fields).
					' FROM '.implode(',', $this->tables).
					($this->where ? ' WHERE '.$this->where : '').
					($this->group ? ' GROUP BY '.$this->group : '').
					($this->order ? ' ORDER BY '.join(',',$this->order) : '');
				break;

			case 'DELETE':
				$sql = "DELETE FROM ".implode(',', $this->tables).($this->where ? ' WHERE '.$this->where : '');
				break;

			case 'INSERT':
				if(!$this->data){
					throw new Exception("NO DATA IN DB.INSERT");
				}
				$data_list = count($this->data) == count($this->data, 1) ? array($this->data) : $this->data;
				$key_str = implode(",", $this->escapeKey(array_keys($data_list[0])));
				$sql = "INSERT INTO ".implode(',', $this->tables)."($key_str) VALUES ";
				$comma = '';
				foreach($data_list as $row){
					$str = array();
					foreach($row as $val){
						if(is_numeric($val)){
							$str[] = $val;
						} else {
							$str[] = $val;
						}
					}
					$value_str = implode(",", $str);
					$sql .= $comma."($value_str)";
					$comma = ',';
				}
				break;

			case 'REPLACE':
			case 'UPDATE':
				if(!$this->data){
					throw new Exception("NO DATA IN DB.UPDATE");
				}
				$data_list = count($this->data) == count($this->data, 1) ? array($this->data) : $this->data;
				$sets = array();
				foreach($data_list as $row){
					$sets = array();
					foreach($row as $field_name => $value){
						$field_name = $this->escapeKey($field_name);
						if($value === null){
							$sets[] = "$field_name = NULL";
						} else {
							$sets[] = "$field_name = ".$value;
						}
					}
				}
				$op_key = $this->operation == 'REPLACE' ? 'REPLACE INTO' : 'UPDATE';
				$sql = "$op_key ".implode(',', $this->tables).' SET '.implode(',', $sets).
					($this->where ? ' WHERE '.$this->where : '');
				break;

			default:
				throw new Exception("NO DB OPERATE SET");
		}
		if($this->limit && stripos(' LIMIT ', $sql) === false){
			if(!$this->limit[0]){
				$sql .= " LIMIT ".$this->limit[1];
			} else {
				$sql .= " LIMIT ".$this->limit[0].','.$this->limit[1];
			}
		}
		return $sql;
	}
}