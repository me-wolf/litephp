var Y = YSL;
var fileSrc, resultState = 'init';
var imgObj = Y.dom.one('#img');

var response = function(msg, code, url){
	imgObj.getDomNode().title = '';
	Y.dom.one('#file').getDomNode().disabled = false;
	if(code == 'succ'){
		resultState = 'done';
		YSL.use('widget.Popup', function(Y, Pop){
			Pop.fire('onSuccess', url);
			Y.showTip('头像设置成功', 'succ');
			setTimeout(function() {
				Pop.closeCurrentPopup();
			}, 1E3);
		});
	} else {
		imgObj.setClass('error');
		Y.showTip(msg, 'err');
		fileSrc = '';
		resultState = 'error';
		console.log(data);
	}
}

var uploadPhoto = function(callback){
	Y.dom.one('#myform').getDomNode().submit();
};

YSL.use('widget.Popup', function(Y, Pop){
	Pop.getCurrentPopup().onClose = function(){
		if(resultState == 'uploading'){
			if(!confirm('头像正在上传中，是否确定要取消？')){
				return false;
			}
		}
		return true;
	};

	Pop.listen('saveSetting', function(){
		if(resultState == 'uploading'){
			Y.showTip('头像正在上传中，请稍侯···', 'tip');
		} else if(resultState == 'error'){
			Y.showTip('头像上传失败，请重新上传', 'err');
		} else if(!fileSrc){
			Y.showTip('请选择您的头像');
		} else {
			resultState = 'uploading';
			imgObj.setClass('loading');
			imgObj.setAttr('src', transPic);
			Y.dom.one('#myform').getDomNode().submit();
			setTimeout(function(){
				Y.dom.one('#file').getDomNode().disabled = true;
			}, 0);
		}
	});

	Y.dom.one('#myform').on('submit', function(){
		Y.showTip('正在上传照片，请稍侯···', 'loading');
	});

	Y.dom.one('#file').on('change', function(e){
		fileSrc = this.getDomNode().value;
		if(!this.getDomNode().value){
			return;
		}
		var file;
		if(e && e.target && e.target.files){
			file = e.target.files[0];
			imgObj.setAttr('src', URL.createObjectURL(file));
		} else {
			imgObj.setAttr('src', transPic);
		}
	});

	imgObj.on('load', function(){
		R.scaleAvaImg(this.getDomNode());
	});
});