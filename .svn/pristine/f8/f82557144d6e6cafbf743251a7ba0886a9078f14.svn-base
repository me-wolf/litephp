(function(Y){
	var TIP_SHOW_TIME = 1.5;
	var DEF_POPUP_WIDTH = 600;
	var _ready = false;

	//解析data-tags属性
	var parseDataTags = function(tags, asArray){
		tags = tags.split(',');
		var ret = asArray ? [] : {};
		if(tags && tags.length){
			for(var i=0; i<tags.length; i++){
				if(!tags[i].trim()){
					continue;
				}
				if(asArray){
					ret.push(tags[i].trim());
				} else {
					ret[tags[i].trim()] = true;
				}
			}
		}
		return ret;
	};

	Y.ready(function(){
		if(_ready){
			return;
		}
		_ready = true;
		//自动弹窗
		Y.dom.one('body').delegate('a[rel=popup]', 'click', function(){
			var src = Y.net.mergeCgiUri(this.getAttr('href'), {'ref':'iframe'});
			var width = parseFloat(this.getAttr('iwidth')) || DEF_POPUP_WIDTH;
			var height = parseFloat(this.getAttr('iheight')) || 0;
			var title = this.getAttr('title') || this.getHtml() || '';
			var onSuccess = this.getAttr('data-onsuccess');
			if(onSuccess){
				eval('var fn1 = window.'+onSuccess);
				onSuccess = fn1;
			} else {
				onSuccess = function(){};
			}

			var onError = this.getAttr('data-onerror');
			if(onError){
				eval('var fn2 = window.'+onError);
				onError = fn2;
			} else {
				onError = function(){};
			}
			var conf = {
				title: title,
				content: {src:src},
				width: width,
				moveEnable: true,
				topCloseBtn: true,
				buttons: []
			};
			if(height){
				conf.height = height;
			}

			Y.use('widget.Popup', function(Y, Pop){
				var p = new Pop(conf);
				p.listen('onSuccess', onSuccess);
				p.listen('onError', onError);
				p.show();
			});

			if(this.getDomNode().tagName == 'A'){
				return false;
			}
		});

		//自动处理后台返回结果
		var auto_process_async = function(node, rsp){
			var onrsp = node.getAttr('onresponse');
			var onsucc = node.getAttr('onsuccess');
			rsp = rsp || {};
			rsp.message = rsp.message || '系统繁忙，请稍后(-1)';
			rsp.code = rsp.code === undefined ? -1 : rsp.code;
			var win = parent.YSL ? parent : window;
			console.log('RSP:', rsp);

			if(onrsp){
				eval('var fn = window.'+onrsp+';');
				fn.call(null, rsp);
			} else if(onsucc){
				if(rsp.code == 0){
					win.YSL.showTip(rsp.message,'succ', TIP_SHOW_TIME);
					setTimeout(function(){
						eval('var fn = window.'+onsucc+';');
						fn.call(null, rsp);
					}, TIP_SHOW_TIME*1000);
				}
				else {
					win.YSL.showTip(rsp.message,'err', TIP_SHOW_TIME);
				}
			}

			//reload page on success
			else {
				win.YSL.showTip(rsp.message, rsp.code ? 'err' : 'succ', TIP_SHOW_TIME);
				if(rsp.code == 0){
					setTimeout(function(){
						if(rsp.url){
							win.location.href = rsp.url;
						} else {
							win.location.reload();
						}
					}, TIP_SHOW_TIME*1000);
				}
			}
		};

		//自动TIP
		Y.dom.one('body').delegate('*[rel=tip]', 'click', function(){
			var tip = this.getAttr('data-tip') || this.getAttr('title');
			if(tip){
				Y.showTip(tip);
			}
		});

		//自动ajax链接
		Y.dom.one('body').delegate('a[rel=async]', 'click', function(){
			var link = this;
			var url = link.getAttr('href');
			var confirmMsg = link.getAttr('data-confirm');
			if(url){
				if(confirmMsg && !confirm(confirmMsg)){
					return false;
				}
				Y.showTip('正在提交请求...', 'load', 10000);
				url = Y.net.mergeCgiUri(url, {ref:'json'});
				Y.net.get(url, null, function(rsp){
					Y.hideTip();
					auto_process_async(link, rsp);
				});
				return false;
			}
		});

		Y.dom.one('body').delegate('input', 'click', function(){
			var confirmMsg = this.getAttr('data-confirm');
			if(confirmMsg && !confirm(confirmMsg)){
				return false;
			}
		});

		//自动select popup类型
		Y.dom.all('select[rel=popup]').each(function(sel){
			sel.on('change', function(){
				var val = this.getValue();
				var sel = this.getDomNode();
				var opt = sel.options[sel.selectedIndex];
				var ti = opt.title || opt.text || opt.name;
				var ex_type = opt.getAttribute('rel') || 'popup';
				var confirmMsg = opt.getAttribute('data-confirm');
				var iwidth = parseInt(opt.getAttribute('iwidth'), 10) || DEF_POPUP_WIDTH;
				var iheight = parseInt(opt.getAttribute('iheight'), 10) || 0;
				if(val){
					if(confirmMsg && !confirm(confirmMsg)){
						return;
					}
					if(ex_type == 'popup'){
						Y.showPopup({
							title: ti,
							content: {src:val},
							width: iwidth,
							height: iheight
						});
					} else if(ex_type == 'async'){
						Y.showTip('提交数据中...', 'load', 5000);
						Y.net.get(val, {ref:'json'}, function(rsp){
							Y.hideTip();
							auto_process_async(Y.dom.one(opt), rsp);
						});
					}
					sel.selectedIndex = 0;
				}
			});

			//同时更新disabled状态
			var o = sel.getDomNode();
			var able = false;
			for(var i=0; i<o.options.length; i++){
				if(o.options[i].value){
					able = true;
					break;
				}
			}
			if(!able){
				o.disabled = 'disabled';
			}
		});

		//自动表单
		Y.dom.all('form[rel=async]').each(function(form){
			window.console && console.log('async form:',form);
			if(form.getAttr('target')){
				return;
			}
			var iframeID = 'formsubmitiframe'+Y.guid();
			var iframe = Y.dom.one('#'+iframeID);
			if(!iframe){
				var span = document.createElement('span');
				span.innerHTML = '<iframe id="'+iframeID+'" name="'+iframeID+'" style="display:none"></iframe>';
				document.body.appendChild(span);
				var iframe = document.getElementById(iframeID);
				iframe._callback = function(rsp){
					form.delAttr('data-submiting');
					Y.hideTip();
					auto_process_async(form, rsp);
				};
			}
			form.on('submit', function(){
				if(form.getAttr('data-submiting')){
					//Y.showTip('网络较慢还在提交数据，请稍侯...', 'load', 10000);
					//return false;
				}
				form.setAttr('data-submiting', '1');
				Y.showTip('正在提交请求...', 'load', 10000);
			});
			form.setAttr('target', iframeID);
			if(form.getAttr('method').toLowerCase() == 'get'){
				form.create('input',0, {
					'type': 'hidden',
					'name': 'ref',
					'value': 'formsender'
				});
			} else {
				form.setAttr('action', Y.net.mergeCgiUri(form.getAttr('action'), {ref: 'formsender'}));
			}
		});

		//日期组件自动绑定
		Y.dom.all('input.date-txt').each(function(txt){
			txt.on('focus', function(){
				if(!this.getAttr('readonly')){
					WdatePicker({dateFmt:'yyyy-MM-dd'});
				}
			});
		});
		Y.dom.all('input.date-time-txt').each(function(txt){
			txt.on('focus', function(){
				if(!this.getAttr('readonly')){
					WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'});
				}
			});
		});
		Y.dom.all('input.form-calendar').each(function(txt){
			txt.on('focus', function(){
				if(!this.getAttr('readonly')){
					WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'});
				}
			});
		});

		//表格空值填充
		Y.dom.all('table.data-tbl').each(function(tbl){
			var con = tbl.one('tbody') || tbl;
			var empty = !con.one('tr');
			if(empty){
				var cs;
				var tmp = tbl.one('tr');
				if(tmp){
					var tds = tmp.all('td');
					var ths = tmp.all('th');
					cs = tds && tds.size();
					cs = cs || (ths && ths.size());
					cs = cs || 100;
				}
				con.setHtml(con.getHtml()+'<tr class="row-empty"><td colspan="'+(cs || 1)+'">没有数据</td></tr>');
			}

			if(tbl.attr('data-'))
			tbl.all('tbody tr td').on('click', function(ev){
				var tag = ev.target.tagName;
				if(/^(A|INPUT|TEXTAREA|BUTTON|LABEL|SELECT)$/.test(tag)){
					return;
				}
				var chk = this.parent().one('input[type=checkbox]');
				if(chk){
					chk = chk.getDomNode();
					chk.checked = !chk.checked;
				}
			});
		});

		window.showUploadImage = function(succCb, errCb){
			succCb = succCb || Y.emptyFn;
			errCb = errCb || Y.emptyFn;
			Y.use('widget.Popup', function(Y, Popup){
				var pop;
				var config = {
					title: '上传图像',
					content: {src:UPLOAD_PAGE_URL},
					topCloseBtn: false,
					width: 400,
					height:200,
					buttons: [
						{name:'上传图片', handler:function(){
							pop.fire('upload');
						}, setDefault:true},
						{name:'取消', handler:function(){
							pop.fire('cancel');
						}}]
				};
				pop = new Popup(config);
				pop.listen('success', function(rsp){
					succCb(rsp.data);
				});
				pop.listen('error', function(rsp){
					errCb(rsp.message);
				});
				pop.show();
			});
		};

		//图片上传控件
		Y.dom.all('input[rel=upload-image]').each(function(input){
			var con = Y.dom.create('a');
			con.addClass('upload-image-btn');
			con.setHtml('上传图片');
			con.insertAfter(input);
			con.on('click', function(){
				showUploadImage(function(url){
					input.setValue(url);
				});
				return false;
			});
		});

		//全选
		Y.dom.all('input[type=checkbox]').each(function(chk){
			var sel_tag = chk.getAttr('data-select-all');
			if(sel_tag !== undefined){
				sel_tag = sel_tag || 'body';
				Y.use('widget.Helper', function(Y, Helper){
					chk.on('click', function(){
						Helper.select(null, sel_tag);
					});
				});
			}
		});

		//自动富文本编辑器
		Y.dom.all('textarea[rel=rich]').each(function(txt){
			var id = Y.guid();
			var name = txt.getAttr('name');
			var div = document.createElement('div');
			var w = parseInt(txt.getStyle('width'), 10) || 400;
			var h = parseInt(txt.getStyle('height'), 10) || 300;
			div.innerHTML = '<script id="'+id+'" name="'+name+'" type="text/plain" style="width:'+w+'px; height:'+h+'px;"></script>'
			Y.dom.one(div).insertAfter(txt);
			txt.hide();
			var ue = UE.getEditor(id);
			setTimeout(function(){
				ue.setContent(txt.getValue());
			}, 1000);
		});
	});
})(YSL);