(function(Y) {
	var R = new function() {
			this.url = function(uri, param) {
				if(!uri){
					return Y.net.mergeCgiUri(SITE_URL, param);
				}
				return Y.net.mergeCgiUri(SITE_URL+'index.php/'+ uri+'?', param);
			};

			this.hideTip = function() {
				if (top.YSL && top.YSL.widget.Tip) {
					top.YSL.widget.Tip.closeAll();
				}
			};

			this.scaleAvaImg = function(obj, minWidth, minHeight) {
				minWidth = minWidth || 120;
				minHeight = minHeight || 120;
				var img = new Image();
				img.onload = function() {
					var newW, newH, ml, mt,
						w = this.width,
						h = this.height;

					if (w > h) {
						newH = minHeight;
						newW = parseInt(w / h * 100, 10);
						ml = parseInt((newW - newH) / 2, 10);
					} else {
						newW = minWidth;
						newH = parseInt(h / w * newW, 10);
						mt = parseInt((newH - newW) / 2, 10);
					}
					var s = 'width:' + newW + 'px;height:' + newH + 'px;' + (ml ? 'margin-left:-' + ml + 'px;' : '') + (mt ? 'margin-top:-' + mt + 'px;' : '');
					obj.style.cssText = s;
				};
				img.src = obj.src;
			};

			this.changeAvatar = function(succCb) {
				succCb = succCb || Y.emptyFn;
				var url = this.url('user/changeAvatar');
				Y.use('widget/Popup', function(Y, Pop) {
					var p = new Pop({
						title: '设置头像',
						content: {
							src: url
						},
						buttons: [{
							name: '保存设置',
							handler: 'saveSetting',
							setDefault: true
						}],
						width: 420,
						height: 190
					});
					p.listen('onSuccess', succCb);
					p.show();
				});
			};

			var _login_cb_list = [];
			var _login_showing = false;

			var _callLoginSucc = function(param) {
				Y.lang.each(_login_cb_list, function(fn) {
					fn(param);
				});
				_login_cb_list = [];
			};

			this.showLogin = function(succCb) {
				succCb = succCb || Y.emptyFn;
				_login_cb_list.push(succCb);
				if (!_login_showing) {
					_login_showing = true;
					Y.use('widget.Popup', function(Y, Pop) {
						var pop = new Pop({
							title: '用户登录',
							content: {
								src: R.url('user/login')
							},
							width: 420,
							height: 180
						});
						pop.listen('loginSucc', function(param) {
							_callLoginSucc(param);
							_login_showing = false;
						});
						pop.onClose = function() {
							_login_showing = false;
						};
						pop.show();
					});
				}
			};
		};

	Y.ready(function() {
		//自动表单
		Y.dom.all('form[data-trans=async]').each(function(form) {
			var iframeID = 'formsubmitiframe' + Y.guid();
			var iframe = Y.dom.one('#' + iframeID);
			if (!iframe) {
				iframe = document.createElement('iframe');
				iframe.id = iframeID;
				iframe.name = iframeID;
				iframe.style.display = 'none';
				iframe.callback = function(rsp) {
					var onresponse = form.getAttr('onresponse');
					if (onresponse) {
						rsp = rsp || {};
						var msg = rsp.message,
							code = rsp.type ? 'succ' : 'err',
							data = rsp.data || '';
						var args = [msg, code, data];
						eval('var fn = window.' + onresponse + ';');
						fn.apply(null, args);
					}
				};

				document.body.appendChild(iframe);
			}
			form.setAttr('target', iframeID);
		});

		Y.use('widget.textAutoResize', function(Y, AR) {
			Y.dom.all('textarea').each(function(txt) {
				console.log('txt', txt);
				AR(txt);
			});
		});

		//auto resize textarea
		Y.dom.one(Y.D).on('keydown', function(e) {
			var tag = Y.event.getTarget(e);
			var node = tag.getDomNode();
			if (node.tagName == 'TEXTAREA' && tag.getAttr('data-auto-resize')) {
				var h = tag.getAttr('data-min-height');
				if (!h) {
					h = parseInt(tag.getStyle('height'), 10);
					tag.setAttr('data-min-height', h);
				}
				tag.setStyle('height', h);
				setTimeout(function() {
					tag.setStyle('height', node.scrollHeight);
				}, 0);
			}
		});
	});

	Y.dom.delegate('a[rel=login-btn]', 'click', function() {
		R.showLogin(function() {
			location.href = R.url('user');
		});
		Y.event.preventDefault();
	});

	window.R = R;
})(YSL);