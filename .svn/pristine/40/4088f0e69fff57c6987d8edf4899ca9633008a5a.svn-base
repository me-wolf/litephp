<?phpsession_start();define('CHK_KEY', 'debug_'.date('ymd'));define('SW_KEY', 'OPEN189_AUTO_LOGIN');			//控制请求URL KEYdefine('AT_KEY', 'OPEN189_ACCESS_TOKEN');define('RT_KEY', 'OPEN189_REFRESH_TOKEN');define('OI_KEY', 'OPEN189_OPEN_ID');/** * 自动登录 * @deprecate 该方法需要占用$_SESSION, $_GET部分变量命名空间，变量名称由define中定义 * 注意，url为当前调用函数所在的页面，该页面和方法会被调用多次，因此不能使用动态地址（如this_url()） * @param array $params * @return boolean **/function open189_auto_login(array $params){	$params = array_merge(array(		'app_id' => null,	//APP ID		'app_secret' => null,	//APP SECRET		'current_url' => remove_from_url(this_url(), SW_KEY),	//入口地址		'success_url' => null,	//成功回调地址，如果没有给出，默认以return true方式给		'error_url' => null		//失败回调地址，如果没有给出，默认以return false方式给出	), $params);		//已经登录	if($_SESSION[AT_KEY]){		return true;	}		//第一次握手回来	if($_GET[SW_KEY]){		$response = open189_access_token(array(			'code' => $_GET['code'],			'app_id' => $params['app_id'],			'app_secret' => $params['app_secret'],			'redirect_uri' => $params['current_url'],			'state' => CHK_KEY		));				if($response && $response['res_code'] == 0){			$_SESSION[AT_KEY] = $response['access_token'];			$_SESSION[RT_KEY] = $response['refresh_token'];			$_SESSION[OI_KEY] = $response['open_id'];						if($params['success_url']){				header('Location:'.$params['success_url']);			}			return true;		} else {			open189_reset();			if($params['error_url']){				header('Location:'.$params['success_url']);			}			dump($response, 1);		}	}		//开始握手	else {		$url .= add_to_url($params['current_url'], array(SW_KEY=>1));		$response = open189_authorize(array('app_id'=>$params['app_id'], 'state'=>CHK_KEY, 'redirect_uri'=>$url));		die($response);	}};/** * 获取记录的 ACCESS_TOKEN * @return string **/function open189_get_access_token(){	return $_SESSION[AT_KEY];}/** * oAuthor授权 * @param array $params * @see http://open.189.cn/index.php?m=content&c=index&a=lists&catid=61#a4**/function open189_authorize(array $params){	$url = 'https://oauth.api.189.cn/emp/oauth2/v2/authorize';	$params = array_merge(array(		'app_id' => null,		'redirect_uri' => '',		'response_type' => 'code',		'state' => '',		'display' => 'page',	//popup		'scope' => null	), $params);		open189_params_check($params, 'app_id,redirect_uri');	return http($url, 'POST', $params);}/** * 获取token * @param array @params**/function open189_access_token(array $params){	$url = 'https://oauth.api.189.cn/emp/oauth2/v2/access_token';	$params = array_merge(array(		'grant_type' => 'authorization_code',		'code' => null,		'app_id' => null,		'app_secret' => null,		'redirect_uri' => null,		'state' => null	), $params);		open189_params_check($params, 'grant_type,code,app_id,app_secret,redirect_uri');	$response_str = http($url, 'POST', $params);	return json_decode($response_str, true);}/** * 注销登录 * @param array $params * @return array * @see http://open.189.cn/index.php?m=content&c=index&a=lists&catid=63**/function open189_logout($params){	$url = 'https://oauth.api.189.cn/emp/oauth2/v2/logout';	$params = array_merge(array(		'app_id' => null,		'access_token' => null,		'redirect_uri' => null	), $params);		open189_reset();	open189_params_check($params, 'app_id,access_token,redirect_uri');	$response = http($url, 'POST', $params);	return $response;};/** * reset session信息 **/function open189_reset(){	unset($_SESSION[SW_KEY]);	unset($_SESSION[AT_KEY]);	unset($_SESSION[RT_KEY]);	unset($_SESSION[OI_KEY]);}